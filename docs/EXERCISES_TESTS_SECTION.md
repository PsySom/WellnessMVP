# Раздел "Упражнения и Тесты" (/exercises-tests)

## Содержание
1. [Общее описание](#общее-описание)
2. [Структура файлов](#структура-файлов)
3. [Архитектура компонентов](#архитектура-компонентов)
4. [Модели данных](#модели-данных)
5. [Система упражнений](#система-упражнений)
6. [Система тестов](#система-тестов)
7. [История результатов](#история-результатов)
8. [Интеграция с календарём](#интеграция-с-календарём)

---

## Общее описание

Раздел **Упражнения и Тесты** предоставляет пользователям доступ к библиотеке психологических упражнений и самодиагностических тестов. Основные функции:

- 🧘 **Упражнения** — пошаговые техники для работы со стрессом, тревогой и эмоциями
- 📋 **Тесты** — валидированные опросники для самооценки психологического состояния
- 📊 **История** — отслеживание прогресса и результатов тестов во времени
- 📅 **Планирование** — добавление упражнений и тестов в календарь

---

## Структура файлов

```
src/
├── pages/
│   ├── ExercisesTests.tsx       # Главная страница раздела
│   ├── Exercises.tsx            # Список упражнений (альтернативный)
│   ├── ExerciseDetail.tsx       # Детали упражнения
│   ├── ExerciseSession.tsx      # Выполнение упражнения
│   ├── Tests.tsx                # Список тестов (альтернативный)
│   ├── TestDetail.tsx           # Детали теста
│   ├── TakeTest.tsx             # Прохождение теста
│   └── TestResult.tsx           # Результаты теста
│
├── components/
│   ├── exercises-tests/
│   │   └── TestHistory.tsx      # История результатов тестов
│   └── admin/
│       ├── AdminExercises.tsx   # Админ-панель упражнений
│       ├── AdminTests.tsx       # Админ-панель тестов
│       ├── ExerciseFormModal.tsx # Форма создания/редактирования упражнения
│       └── TestFormModal.tsx    # Форма создания/редактирования теста
│
└── integrations/supabase/
    └── types.ts                 # TypeScript типы из БД
```

---

## Архитектура компонентов

```
┌─────────────────────────────────────────────────────────────────┐
│                     ExercisesTests.tsx                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Tabs: [Упражнения и тесты] [История]                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│         ┌────────────────────┼────────────────────┐            │
│         ▼                                         ▼            │
│  ┌─────────────────────┐               ┌──────────────────┐   │
│  │    Items Tab        │               │  TestHistory     │   │
│  │  ┌───────────────┐  │               │                  │   │
│  │  │ Search Bar    │  │               │  [Фильтр тестов] │   │
│  │  ├───────────────┤  │               │  [График баллов] │   │
│  │  │ Type Filter   │  │               │  [Список дат]    │   │
│  │  │ [All/Ex/Tests]│  │               └──────────────────┘   │
│  │  ├───────────────┤  │                                       │
│  │  │Category Filter│  │                                       │
│  │  ├───────────────┤  │                                       │
│  │  │  Grid of      │  │                                       │
│  │  │  Exercise/    │──┼──────────► ExerciseDetail.tsx        │
│  │  │  Test Cards   │  │             ExerciseSession.tsx       │
│  │  │               │──┼──────────► TestDetail.tsx             │
│  │  │               │  │             TakeTest.tsx              │
│  │  └───────────────┘  │             TestResult.tsx            │
│  └─────────────────────┘                                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## Модели данных

### Exercise (Упражнение)

```typescript
interface Exercise {
  id: string;                  // UUID
  slug: string;                // URL-slug (e.g., "box-breathing")
  name: string;                // Название (RU)
  name_en: string;             // Название (EN)
  name_ru: string | null;      // Название (RU)
  name_fr: string;             // Название (FR)
  description: string | null;  // Описание
  description_en: string | null;
  description_ru: string | null;
  description_fr: string | null;
  category: string;            // Категория: grounding, stress, anxiety, cognitive
  difficulty: string;          // Сложность: easy, medium, hard
  duration_minutes: number;    // Продолжительность в минутах
  effects: string[];           // Эффекты упражнения
  effects_en: string[] | null;
  effects_ru: string[] | null;
  effects_fr: string[] | null;
  emoji: string;               // Эмодзи
  instructions: Instruction[]; // Инструкции
  instructions_en: Instruction[] | null;
  instructions_ru: Instruction[] | null;
  instructions_fr: Instruction[] | null;
  created_at: string;
}

interface Instruction {
  step: number;        // Номер шага
  title: string;       // Заголовок шага
  content: string;     // Содержание инструкции
  duration?: number;   // Длительность шага в секундах
}
```

### Test (Тест)

```typescript
interface Test {
  id: string;                   // UUID
  slug: string;                 // URL-slug (e.g., "gad-7")
  name: string;                 // Название
  name_en: string;
  name_ru: string | null;
  name_fr: string;
  description: string | null;   // Описание
  description_en: string | null;
  description_ru: string | null;
  description_fr: string | null;
  duration_minutes: number;     // Время на прохождение
  total_questions: number;      // Количество вопросов
  questions: Question[];        // Вопросы теста
  questions_ru: Question[] | null;
  questions_fr: Question[] | null;
  scoring_info: ScoringInfo;    // Информация о подсчёте баллов
  scoring_info_ru: ScoringInfo | null;
  scoring_info_fr: ScoringInfo | null;
  created_at: string;
}

interface Question {
  id: number;
  text: string;           // Текст вопроса
  options: Option[];      // Варианты ответов
}

interface Option {
  label: string;  // Текст варианта
  value: number;  // Балл за выбор
}

interface ScoringInfo {
  ranges: ScoringRange[];
}

interface ScoringRange {
  min: number;       // Минимальный балл
  max: number;       // Максимальный балл
  category: string;  // Категория результата (e.g., "minimal", "mild")
  label: string;     // Человекочитаемое описание
}
```

### TestResult (Результат теста)

```typescript
interface TestResult {
  id: string;
  user_id: string;
  test_id: string;
  score: number;           // Набранные баллы
  max_score: number;       // Максимально возможные баллы
  category: string;        // Категория результата
  answers: Record<string, number>;  // Ответы пользователя
  completed_at: string;
}
```

### ExerciseSession (Сессия упражнения)

```typescript
interface ExerciseSession {
  id: string;
  user_id: string;
  exercise_id: string;
  duration_minutes: number;   // Затраченное время
  mood_before: number | null; // Настроение до (1-10)
  mood_after: number | null;  // Настроение после (1-10)
  notes: string | null;       // Заметки пользователя
  completed_at: string;
}
```

---

## Система упражнений

### Категории упражнений

| Категория | Ключ | Описание |
|-----------|------|----------|
| 🌊 Заземление | `grounding` | Техники для возвращения в настоящий момент |
| 😤 Стресс | `stress` | Упражнения для снижения стресса |
| 😰 Тревожность | `anxiety` | Методы работы с тревогой |
| 🧠 Когнитивные | `cognitive` | Техники изменения мышления |

### Уровни сложности

| Уровень | Индикатор | Описание |
|---------|-----------|----------|
| Лёгкий | • | Простые техники для новичков |
| Средний | •• | Требуют некоторой практики |
| Сложный | ••• | Продвинутые методики |

---

### Каталог упражнений

#### 1. 🌬️ Дыхание 4-7-8 (4-7-8 Breathing)
- **Категория:** Стресс
- **Сложность:** Лёгкая
- **Длительность:** 5 минут
- **Эффекты:** Снижает стресс, замедляет сердцебиение, улучшает сон

**Алгоритм выполнения:**
```
1. Подготовка (10 сек)
   └── Сядьте удобно, спина прямая. Кончик языка за верхними зубами.

2. Полный выдох (8 сек)
   └── Полностью выдохните через рот со звуком "свист".

3. Вдох (4 сек)
   └── Закройте рот и тихо вдохните через нос на 4 счёта.

4. Задержка (7 сек)
   └── Задержите дыхание на 7 счётов.

5. Выдох (8 сек)
   └── Полностью выдохните через рот на 8 счётов.

6. Повторение
   └── Повторите цикл 3-4 раза.
```

**Научное обоснование:** Активирует парасимпатическую нервную систему, снижая уровень кортизола.

---

#### 2. 🌊 Техника 5-4-3-2-1 (5-4-3-2-1 Grounding)
- **Категория:** Заземление
- **Сложность:** Лёгкая
- **Длительность:** 5 минут
- **Эффекты:** Снижает тревожность, усиливает осознанность, успокаивает мысли

**Алгоритм выполнения:**
```
1. 5 вещей, которые ВИДИТЕ
   └── Осмотритесь и назовите 5 предметов. Опишите цвета, формы, детали.

2. 4 вещи, которые ЧУВСТВУЕТЕ на ощупь
   └── Обратите внимание на текстуры. Потрогайте предметы если возможно.

3. 3 вещи, которые СЛЫШИТЕ
   └── Прислушайтесь. Какие звуки рядом? Какие вдалеке?

4. 2 вещи, которые ЧУВСТВУЕТЕ запах
   └── Какие ароматы присутствуют? Если ничего, вспомните любимый запах.

5. 1 вещь, которую ОЩУЩАЕТЕ на вкус
   └── Какой вкус во рту? Можете сделать глоток воды.
```

**Когда использовать:** Панические атаки, сильная тревога, диссоциация.

---

#### 3. 📦 Квадратное дыхание (Box Breathing)
- **Категория:** Стресс
- **Сложность:** Лёгкая
- **Длительность:** 5 минут
- **Эффекты:** Балансирует нервную систему, улучшает концентрацию, снижает стресс

**Алгоритм выполнения:**
```
┌─────────────┐
│   ВДОХ 4с   │
│      ▲      │
│      │      │
│  ◄───┴───►  │
│ЗАДЕРЖКА  ЗАДЕРЖКА
│   4с       4с│
│      │      │
│      ▼      │
│  ВЫДОХ 4с   │
└─────────────┘

Цикл: Вдох (4с) → Задержка (4с) → Выдох (4с) → Задержка (4с)
Повторить 4 раза.
```

**Применение:** Используется морскими котиками США для контроля стресса.

---

#### 4. 🧘 Сканирование тела (Body Scan Meditation)
- **Категория:** Заземление
- **Сложность:** Средняя
- **Длительность:** 10 минут
- **Эффекты:** Снимает напряжение, улучшает осознание тела, способствует расслаблению

**Алгоритм выполнения:**
```
1. Примите удобное положение
   └── Сядьте или лягте. Закройте глаза.

2. Стопы
   └── Ощутите стопы: тепло, холод, давление, покалывание.

3. Ноги
   └── Медленно поднимайтесь вверх: икры, колени, бёдра.

4. Торс
   └── Живот, грудь, спина. Заметьте движение дыхания.

5. Руки
   └── Плечи, предплечья, кисти, пальцы.

6. Голова
   └── Шея, лицо, макушка. Расслабьте напряжение.

7. Всё тело
   └── Ощутите тело как единое целое. Три глубоких вдоха.
```

---

#### 5. 💪 Прогрессивная мышечная релаксация (Progressive Muscle Relaxation)
- **Категория:** Стресс
- **Сложность:** Средняя
- **Длительность:** 15 минут
- **Эффекты:** Снимает мышечное напряжение, снижает стресс, улучшает осознание тела

**Алгоритм выполнения:**
```
Для каждой группы мышц:
  1. НАПРЯГИТЕ на 5 секунд
  2. РАССЛАБЬТЕ на 10-15 секунд
  3. Заметьте разницу

Последовательность групп мышц:
  1. Кисти и предплечья
  2. Бицепсы
  3. Плечи
  4. Лоб
  5. Глаза и нос
  6. Челюсть
  7. Шея
  8. Грудь
  9. Живот
  10. Бёдра
  11. Икры
  12. Стопы
```

---

#### 6. 🔄 Когнитивный рефрейминг (Cognitive Reframing)
- **Категория:** Когнитивные
- **Сложность:** Сложная
- **Длительность:** 10 минут
- **Эффекты:** Меняет перспективу, снижает негативное мышление, увеличивает гибкость

**Алгоритм выполнения:**
```
1. Определите негативную мысль
   └── Какая мысль вызывает дискомфорт?

2. Исследуйте доказательства
   └── Какие факты поддерживают эту мысль? Какие противоречат?

3. Найдите когнитивные искажения
   └── Это катастрофизация? Чтение мыслей? Чёрно-белое мышление?

4. Создайте альтернативу
   └── Какой более сбалансированный взгляд возможен?

5. Оцените результат
   └── Как вы чувствуете себя с новой перспективой?
```

---

#### 7. 🪜 Лестница экспозиции (Anxiety Exposure Ladder)
- **Категория:** Тревожность
- **Сложность:** Сложная
- **Длительность:** 20 минут
- **Эффекты:** Снижает избегание, повышает уверенность, уменьшает тревогу со временем

**Алгоритм выполнения:**
```
1. Определите страх
   └── Какая ситуация или вещь вызывает тревогу?

2. Оцените уровень страха (0-10)
   └── Насколько сильный страх?

3. Разбейте на шаги
   └── Составьте список более мелких версий столкновения со страхом.

4. Начните с малого
   └── Выберите шаг с уровнем тревоги 2-3.

5. Оставайтесь, пока тревога не снизится
   └── Находитесь в ситуации до снижения тревоги вдвое.

6. Двигайтесь вверх
   └── Когда комфортно — переходите к следующему уровню.

7. Празднуйте прогресс
   └── Признавайте каждый шаг, даже маленький.
```

---

#### 8. 🫧 Техника дыхания "Диафрагмальное дыхание" (Diaphragmatic Breathing)
- **Категория:** Стресс
- **Сложность:** Лёгкая
- **Длительность:** 8 минут
- **Эффекты:** Активирует релаксацию, снижает частоту сердцебиения, улучшает оксигенацию

**Алгоритм выполнения:**
```
1. Положение
   └── Лягте или сядьте. Одна рука на груди, другая на животе.

2. Вдох через нос
   └── Дышите так, чтобы рука на животе поднималась, а на груди оставалась неподвижной.

3. Выдох через рот
   └── Медленно выдыхайте, живот опускается.

4. Ритм
   └── Вдох 4 секунды, выдох 6 секунд.

5. Повторение
   └── Продолжайте 5-10 минут.
```

---

### Логика выполнения упражнения

```
┌─────────────────────────────────────────────────────────────┐
│                   ExerciseSession.tsx                        │
├─────────────────────────────────────────────────────────────┤
│  1. Загрузка упражнения из БД по slug                       │
│                      ▼                                       │
│  2. Отображение текущего шага инструкции                    │
│     ┌─────────────────────────────────────┐                 │
│     │  Шаг 1/6: Подготовка                │                 │
│     │  ════════════════════               │                 │
│     │  Сядьте удобно...                   │                 │
│     │                                     │                 │
│     │  [◄ Назад]              [Далее ►]  │                 │
│     └─────────────────────────────────────┘                 │
│                      ▼                                       │
│  3. Навигация между шагами (handleNext/handlePrevious)      │
│                      ▼                                       │
│  4. По завершении последнего шага → экран завершения        │
│     ┌─────────────────────────────────────┐                 │
│     │  ✓ Упражнение завершено!            │                 │
│     │                                     │                 │
│     │  Как вы себя чувствуете? (1-10)    │                 │
│     │  [😞] [😐] [🙂] [😊] [😄]           │                 │
│     │                                     │                 │
│     │  Заметки: [________________]        │                 │
│     │                                     │                 │
│     │        [Сохранить]                  │                 │
│     └─────────────────────────────────────┘                 │
│                      ▼                                       │
│  5. Сохранение в exercise_sessions                          │
│     - user_id                                                │
│     - exercise_id                                            │
│     - duration_minutes                                       │
│     - mood_after                                             │
│     - notes                                                  │
└─────────────────────────────────────────────────────────────┘
```

---

## Система тестов

### Каталог тестов

#### 1. 📋 Тест тревожности GAD-7 (Generalized Anxiety Disorder)
- **Длительность:** 5 минут
- **Вопросов:** 7
- **Диапазон баллов:** 0-21

**Шкала оценки:**
| Баллы | Категория | Интерпретация |
|-------|-----------|---------------|
| 0-4 | Минимальная | Тревожность в норме |
| 5-9 | Лёгкая | Есть признаки тревожности |
| 10-14 | Умеренная | Рекомендуется консультация специалиста |
| 15-21 | Выраженная | Необходима профессиональная помощь |

**Вопросы:**
1. Чувство нервозности, тревоги или напряжения
2. Неспособность прекратить или контролировать беспокойство
3. Чрезмерное беспокойство о разных вещах
4. Трудности с расслаблением
5. Такое беспокойство, что трудно усидеть на месте
6. Легко раздражаетесь или становитесь нервным
7. Чувство страха, как будто может произойти что-то ужасное

**Варианты ответов:**
- Совсем нет (0)
- Несколько дней (1)
- Более половины дней (2)
- Почти каждый день (3)

---

#### 2. 📋 Тест депрессии PHQ-9 (Patient Health Questionnaire)
- **Длительность:** 5 минут
- **Вопросов:** 9
- **Диапазон баллов:** 0-27

**Шкала оценки:**
| Баллы | Категория | Интерпретация |
|-------|-----------|---------------|
| 0-4 | Минимальная | Депрессия отсутствует |
| 5-9 | Лёгкая | Есть признаки депрессии |
| 10-14 | Умеренная | Рекомендуется мониторинг |
| 15-19 | Умеренно-выраженная | Необходимо лечение |
| 20-27 | Выраженная | Срочная помощь специалиста |

**Вопросы:**
1. Мало интереса или удовольствия от деятельности
2. Чувство подавленности, депрессии или безнадёжности
3. Проблемы со сном
4. Чувство усталости или отсутствия энергии
5. Плохой аппетит или переедание
6. Плохое мнение о себе
7. Трудности с концентрацией
8. Замедленные движения или речь / беспокойство
9. Мысли о причинении себе вреда

---

#### 3. 📋 Тест на уровень стресса PSS-10 (Perceived Stress Scale)
- **Длительность:** 5 минут
- **Вопросов:** 10
- **Диапазон баллов:** 0-40

**Шкала оценки:**
| Баллы | Категория | Интерпретация |
|-------|-----------|---------------|
| 0-13 | Низкий | Стресс в норме |
| 14-26 | Умеренный | Средний уровень стресса |
| 27-40 | Высокий | Требуется внимание |

**Вопросы оценивают:**
- Частоту неожиданных расстройств
- Ощущение потери контроля
- Нервозность и стресс
- Уверенность в способности справиться с проблемами
- Ощущение, что дела идут своим чередом

---

#### 4. 📋 Тест когнитивных искажений
- **Длительность:** 10 минут
- **Вопросов:** 15
- **Диапазон баллов:** 0-60

**Шкала оценки:**
| Баллы | Категория | Интерпретация |
|-------|-----------|---------------|
| 0-15 | Минимальные | Здоровое мышление |
| 16-30 | Лёгкие | Есть некоторые искажения |
| 31-45 | Умеренные | Работа над мышлением полезна |
| 46-60 | Высокие | Рекомендуется когнитивная терапия |

**Измеряемые искажения:**
1. Чёрно-белое мышление
2. Фильтрация негатива
3. Катастрофизация
4. Минимизация достижений
5. Поспешные выводы
6. Персонализация
7. Долженствование
8. Навешивание ярлыков
9. Самообвинение
10. Сверхобобщение
11. Чтение мыслей
12. Обесценивание позитива
13. Эмоциональное рассуждение
14. Сравнение с другими
15. Фокус на неконтролируемом

---

### Логика прохождения теста

```
┌─────────────────────────────────────────────────────────────┐
│                      TakeTest.tsx                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. Загрузка теста из БД по slug                            │
│     ├── questions (локализованные)                          │
│     └── scoring_info (диапазоны баллов)                     │
│                      ▼                                       │
│  2. Инициализация состояния                                 │
│     ├── answers: Record<questionId, value> = {}             │
│     └── currentQuestion: number = 0                         │
│                      ▼                                       │
│  3. Отображение вопроса                                     │
│     ┌─────────────────────────────────────┐                 │
│     │  Вопрос 3/7                         │                 │
│     │  ▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░ 43%         │                 │
│     │                                     │                 │
│     │  Чрезмерное беспокойство о          │                 │
│     │  разных вещах                       │                 │
│     │                                     │                 │
│     │  ○ Совсем нет                       │                 │
│     │  ● Несколько дней                   │◄── RadioGroup   │
│     │  ○ Более половины дней              │                 │
│     │  ○ Почти каждый день                │                 │
│     │                                     │                 │
│     │  [◄ Назад]              [Далее ►]  │                 │
│     └─────────────────────────────────────┘                 │
│                      ▼                                       │
│  4. handleAnswer(questionId, value)                         │
│     └── Обновляет answers[questionId] = value               │
│                      ▼                                       │
│  5. Навигация                                               │
│     ├── goToNext(): currentQuestion++                       │
│     └── goToPrevious(): currentQuestion--                   │
│                      ▼                                       │
│  6. submitTest() — при завершении всех вопросов             │
│     ├── calculateScore(): sum(Object.values(answers))       │
│     ├── getCategory(score): find matching range             │
│     ├── INSERT INTO test_results                            │
│     │   ├── user_id                                         │
│     │   ├── test_id                                         │
│     │   ├── score                                           │
│     │   ├── max_score                                       │
│     │   ├── category                                        │
│     │   └── answers (JSONB)                                 │
│     └── navigate(`/tests/${slug}/results/${resultId}`)      │
│                      ▼                                       │
│  7. TestResult.tsx — отображение результата                 │
│     ├── Балл и процент                                      │
│     ├── Категория с цветовой индикацией                     │
│     ├── Интерпретация результата                            │
│     ├── Рекомендации                                        │
│     └── Кнопки: Пройти снова, Поделиться, История           │
└─────────────────────────────────────────────────────────────┘
```

### Алгоритм подсчёта баллов

```typescript
// calculateScore — суммирует все ответы
const calculateScore = (): number => {
  return Object.values(answers).reduce((sum, value) => sum + value, 0);
};

// getCategory — находит категорию по баллу
const getCategory = (score: number): string => {
  const range = test.scoring_info.ranges.find(
    r => score >= r.min && score <= r.max
  );
  return range?.category || 'unknown';
};
```

### Цветовая индикация результатов

| Категория | Цвет | CSS-класс |
|-----------|------|-----------|
| minimal, low | 🟢 Зелёный | `bg-success/10 text-success` |
| mild, moderate | 🟡 Жёлтый | `bg-warning/10 text-warning` |
| severe, high | 🔴 Красный | `bg-destructive/10 text-destructive` |

---

## История результатов

### Компонент TestHistory

```
┌─────────────────────────────────────────────────────────────┐
│                     TestHistory.tsx                          │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Фильтр: [Все тесты ▼]                              │    │
│  │          ├── Все тесты                              │    │
│  │          ├── GAD-7 (Тревожность)                    │    │
│  │          ├── PHQ-9 (Депрессия)                      │    │
│  │          └── PSS-10 (Стресс)                        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  📋 GAD-7 Тест тревожности                     [▼]  │    │
│  │  Последний результат: Лёгкая • 7 баллов • 2д назад  │    │
│  │                                                     │    │
│  │  ▼ Развёрнуто:                                      │    │
│  │  ┌─────────────────────────────────────────────┐   │    │
│  │  │ Баллы: [5] [7] [6] [8] [7]                  │   │    │
│  │  │        ──────────────────────              │   │    │
│  │  │   10 ┤                     ●               │   │    │
│  │  │    8 ┤          ●      ●                   │   │    │
│  │  │    6 ┤      ●       ●                      │   │    │
│  │  │    4 ┤  ●                                  │   │    │
│  │  │    2 ┤                                     │   │    │
│  │  │    0 └──────────────────────►              │   │    │
│  │  │      1нед  2нед  3нед  4нед  сегодня       │   │    │
│  │  └─────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### Логика загрузки истории

```typescript
const loadTestHistory = async () => {
  // 1. Получить результаты пользователя
  const { data: results } = await supabase
    .from('test_results')
    .select('*')
    .eq('user_id', user.id)
    .order('completed_at', { ascending: false });

  // 2. Получить информацию о тестах
  const testIds = [...new Set(results.map(r => r.test_id))];
  const { data: tests } = await supabase
    .from('tests')
    .select('id, name_en, name_ru, slug')
    .in('id', testIds);

  // 3. Сгруппировать результаты по тестам
  const groupedResults = tests.map(test => ({
    ...test,
    results: results.filter(r => r.test_id === test.id)
  }));
};
```

---

## Интеграция с календарём

### Добавление упражнения/теста в расписание

```
┌─────────────────────────────────────────────────────────────┐
│            ActivityFormModal (prefilledActivity)             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  При нажатии кнопки "Запланировать" (CalendarPlus):         │
│                                                              │
│  handleSchedule(item, type) {                               │
│    setSelectedItem(item);                                   │
│    setSelectedType(type);  // 'exercise' | 'test'           │
│    setActivityModalOpen(true);                              │
│  }                                                           │
│                                                              │
│  getPrefilledActivity() {                                   │
│    return {                                                  │
│      title: getLocalizedField(selectedItem, 'name'),        │
│      duration_minutes: selectedItem.duration_minutes,       │
│      impact_type: type === 'exercise'                       │
│        ? 'restoring' : 'neutral',                           │
│      category: type === 'exercise'                          │
│        ? 'psychological_exercises' : 'testing',             │
│      date: new Date(),                                       │
│      anytime: true,                                          │
│      exercise_id: type === 'exercise' ? item.id : undefined,│
│      test_id: type === 'test' ? item.id : undefined,        │
│    };                                                        │
│  }                                                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### Связь activities с exercises/tests

В таблице `activities` есть поля:
- `exercise_id` — UUID упражнения (NULL если не упражнение)
- `test_id` — UUID теста (NULL если не тест)

Это позволяет:
1. Привязывать активность к конкретному упражнению/тесту
2. Быстро переходить к выполнению из календаря
3. Отслеживать, какие упражнения/тесты запланированы

---

## Административное управление

### AdminExercises

Позволяет администраторам:
- Просматривать список всех упражнений
- Создавать новые упражнения
- Редактировать существующие (название, категория, инструкции)
- Удалять упражнения

### AdminTests

Позволяет администраторам:
- Просматривать список всех тестов
- Создавать новые тесты с вопросами
- Редактировать вопросы и шкалы оценки
- Удалять тесты

### Формы создания/редактирования

```
ExerciseFormModal:
  - name (EN/RU/FR)
  - description (EN/RU/FR)
  - category (select)
  - difficulty (select)
  - duration_minutes
  - emoji
  - effects (массив)
  - instructions (массив шагов)

TestFormModal:
  - name (EN/RU/FR)
  - description (EN/RU/FR)
  - duration_minutes
  - total_questions
  - questions (массив)
  - scoring_info (диапазоны)
```

---

## Локализация

Все тексты локализованы на три языка:
- 🇬🇧 English (en)
- 🇷🇺 Русский (ru)
- 🇫🇷 Français (fr)

Используется хук `useLocale` с методами:
- `getLocalizedField(obj, 'name')` — получает `name_en`, `name_ru` или `name_fr`
- `getLocalizedObject(obj, 'instructions')` — для массивов и объектов

---

## Диаграмма потока данных

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  exercises  │      │    tests    │      │ test_results│
│   (table)   │      │   (table)   │      │   (table)   │
└──────┬──────┘      └──────┬──────┘      └──────┬──────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────┐
│                   ExercisesTests.tsx                     │
│  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ Exercise Cards  │  │        Test Cards           │  │
│  │  + last results │  │    + last result badges     │  │
│  └────────┬────────┘  └──────────────┬──────────────┘  │
└───────────┼──────────────────────────┼─────────────────┘
            │                          │
     ┌──────┴──────┐            ┌──────┴──────┐
     ▼             ▼            ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│ Exercise │  │ Exercise │  │  Test    │  │  Take    │
│  Detail  │→ │ Session  │  │  Detail  │→ │  Test    │
└──────────┘  └────┬─────┘  └──────────┘  └────┬─────┘
                   │                           │
                   ▼                           ▼
            ┌─────────────┐             ┌─────────────┐
            │  exercise_  │             │   test_     │
            │  sessions   │             │  results    │
            │   (table)   │             │  (table)    │
            └─────────────┘             └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │ TestResult  │
                                        │   Page      │
                                        └─────────────┘
```
